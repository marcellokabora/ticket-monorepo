name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:

# Sets permissions of the GITHUB_TOKEN to allow deployment to GitHub Pages
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment, skipping runs queued between the run in-progress and latest queued.
concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  build:
    runs-on: ubuntu-latest
    environment: github-pages
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "22"

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10.26.0

      - name: Get pnpm store directory
        shell: bash
        run: |
          echo "STORE_PATH=$(pnpm store path --silent)" >> $GITHUB_ENV

      - name: Setup pnpm cache
        uses: actions/cache@v4
        with:
          path: ${{ env.STORE_PATH }}
          key: ${{ runner.os }}-pnpm-store-${{ hashFiles('**/pnpm-lock.yaml') }}
          restore-keys: |
            ${{ runner.os }}-pnpm-store-

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Restore Turbo cache
        uses: actions/cache@v4
        with:
          path: |
            .turbo
            node_modules/.cache/turbo
          key: ${{ runner.os }}-turbo-${{ hashFiles('**/pnpm-lock.yaml') }}-${{ github.sha }}
          restore-keys: |
            ${{ runner.os }}-turbo-${{ hashFiles('**/pnpm-lock.yaml') }}-
            ${{ runner.os }}-turbo-

      - name: Build all apps and packages
        run: pnpm build
        env:
          NODE_ENV: production
          NITRO_PRESET: static
          VITE_API_BASE_URI: ${{ secrets.VITE_API_BASE_URI }}
          VITE_APP_AUTH_TOKEN: ${{ secrets.VITE_APP_AUTH_TOKEN }}

      - name: Build Homepage (Next.js)
        run: pnpm --filter @ticketapp/homepage build
        env:
          NODE_ENV: production

      - name: Build Dashboard (Svelte)
        run: pnpm --filter @ticketapp/dashboard build
        env:
          NODE_ENV: production

      - name: Build Storybook for ui
        run: pnpm --filter @ticketapp/ui build-storybook
        env:
          NODE_ENV: production

      - name: Debug - List build outputs
        run: |
          echo "=== Checking which apps were built ==="
          [ -d "apps/react-app/dist" ] && echo "✓ React app built" || echo "✗ React app not built"
          [ -d "apps/nuxt-app/.output/public" ] && echo "✓ Nuxt app built" || echo "✗ Nuxt app not built"
          [ -d "apps/svelte-app/dist" ] && echo "✓ Svelte app built" || echo "✗ Svelte app not built"
          [ -d "apps/booking/dist" ] && echo "✓ Booking app built" || echo "✗ Booking app not built"
          [ -d "packages/ui/storybook-static" ] && echo "✓ Storybook built" || echo "✗ Storybook not built"
          [ -d "apps/dashboard/dist" ] && echo "✓ Dashboard built" || echo "✗ Dashboard not built"
          echo ""
          echo "=== Directory structure ==="
          ls -la apps/react-app/ || echo "React app dir not found"
          ls -la apps/nuxt-app/ || echo "Nuxt app dir not found"
          ls -la apps/svelte-app/ || echo "Svelte app dir not found"
          ls -la packages/ui/ || echo "UI components dir not found"

      - name: Create deployment directory structure
        run: |
          mkdir -p deploy
          mkdir -p deploy/dashboard
          mkdir -p deploy/react
          mkdir -p deploy/vue
          mkdir -p deploy/svelte
          mkdir -p deploy/booking
          mkdir -p deploy/storybook

      - name: Copy Homepage build (root)
        run: |
          if [ -d "apps/homepage/out" ]; then
            echo "Copying Homepage app to root..."
            cp -r apps/homepage/out/* deploy/
          else
            echo "ERROR: Homepage not built!"
            exit 1
          fi

      - name: Copy Dashboard build
        run: |
          if [ -d "apps/dashboard/dist" ]; then
            echo "Copying Dashboard app..."
            cp -r apps/dashboard/dist/* deploy/dashboard/
          else
            echo "ERROR: Dashboard app not built!"
            exit 1
          fi

      - name: Copy React build
        run: |
          if [ -d "apps/react-app/dist" ]; then
            echo "Copying React app..."
            cp -r apps/react-app/dist/* deploy/react/
          else
            echo "WARNING: React app not built (optional)"
          fi

      - name: Copy Nuxt build
        run: |
          if [ -d "apps/nuxt-app/.output/public" ]; then
            echo "Copying Nuxt app..."
            cp -r apps/nuxt-app/.output/public/* deploy/vue/
          else
            echo "WARNING: Nuxt app not built (optional)"
          fi

      - name: Copy Svelte build
        run: |
          if [ -d "apps/svelte-app/dist" ]; then
            echo "Copying Svelte app..."
            cp -r apps/svelte-app/dist/* deploy/svelte/
          else
            echo "WARNING: Svelte app not built (optional)"
          fi

      - name: Copy Booking build
        run: |
          if [ -d "apps/booking/dist" ]; then
            echo "Copying Booking app..."
            cp -r apps/booking/dist/* deploy/booking/
          else
            echo "WARNING: Booking app not built (optional)"
          fi

      - name: Copy Storybook build
        run: |
          if [ -d "packages/ui/storybook-static" ]; then
            echo "Copying Storybook..."
            cp -r packages/ui/storybook-static/* deploy/storybook/
          else
            echo "WARNING: Storybook not built (optional)"
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v4
        with:
          enablement: true

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: "./deploy"

  deploy:
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
